<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GNU CommonC++: thread1.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>thread1.cpp</h1><div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Synchronization and threading services.">cc++/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;cstdio&gt;</span>

<span class="preprocessor">#ifdef  CCXX_NAMESPACES</span>
<span class="preprocessor"></span><span class="keyword">using namespace </span>ost;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">// This is a little regression test</span>
<span class="comment">//</span>

<span class="keyword">class </span>ThreadTest: <span class="keyword">public</span> <a name="_a0"></a><a class="code" href="classost_1_1_thread.html" title="Every thread of execution in an application is created by instantiating an object...">Thread</a>
{
<span class="keyword">public</span>:
        ThreadTest();
        <span class="keywordtype">void</span> <a name="a1"></a><a class="code" href="classost_1_1_thread.html#add7d339d94b8a1ed2b2b0324a95b7e74" title="All threads execute by deriving the Run method of Thread.">run</a>();
};

<span class="keyword">volatile</span> <span class="keywordtype">int</span> n = 0;

<span class="keywordtype">bool</span> WaitNValue(<span class="keywordtype">int</span> value)
{
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;; ++i) {
                <span class="keywordflow">if</span> (n == value)
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">if</span> (i &gt;= 100)
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                Thread::sleep(10);
        }
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
}

<span class="keywordtype">bool</span> WaitChangeNValue(<span class="keywordtype">int</span> value)
{
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;; ++i) {
                <span class="keywordflow">if</span> (n != value)
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">if</span> (i &gt;= 100)
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                Thread::sleep(10);
        }
        <span class="keywordflow">return</span> <span class="keyword">true</span>;
}

ThreadTest::ThreadTest()
{
}

<span class="keywordtype">void</span> <a class="code" href="classost_1_1_thread.html#add7d339d94b8a1ed2b2b0324a95b7e74" title="All threads execute by deriving the Run method of Thread.">ThreadTest::run</a>()
{
        setCancel(Thread::cancelDeferred);
        n = 1;

        <span class="comment">// wait for main thread</span>
        <span class="keywordflow">if</span> (!WaitNValue(2)) <span class="keywordflow">return</span>;

        <span class="comment">// increment infinitely</span>
        <span class="keywordflow">for</span>(;;) {
                yield();
                n = n+1;
        }
}

<span class="keywordtype">bool</span> TestChange(<span class="keywordtype">bool</span> shouldChange)
{
        <span class="keywordflow">if</span> (shouldChange)
                printf(<span class="stringliteral">&quot;- thread should change n...&quot;</span>);
        <span class="keywordflow">else</span>
                printf(<span class="stringliteral">&quot;- thread should not change n...&quot;</span>);
        <span class="keywordflow">if</span> (WaitChangeNValue(n) == shouldChange) {
                printf(<span class="stringliteral">&quot;ok\n&quot;</span>);
                <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
        printf(<span class="stringliteral">&quot;ko\n&quot;</span>);
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
}

<span class="preprocessor">#undef ERROR</span>
<span class="preprocessor"></span><span class="preprocessor">#undef OK</span>
<span class="preprocessor"></span><span class="preprocessor">#define ERROR {printf(&quot;ko\n&quot;); return 1; }</span>
<span class="preprocessor"></span><span class="preprocessor">#define OK {printf(&quot;ok\n&quot;); }</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define TEST_CHANGE(b) if (!TestChange(b)) return 1;</span>
<span class="preprocessor"></span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
        ThreadTest test;

        <span class="comment">// test only thread, without sincronization</span>
        printf(<span class="stringliteral">&quot;***********************************************\n&quot;</span>);
        printf(<span class="stringliteral">&quot;* Testing class Thread without syncronization *\n&quot;</span>);
        printf(<span class="stringliteral">&quot;***********************************************\n&quot;</span>);

        printf(<span class="stringliteral">&quot;Testing thread creation\n\n&quot;</span>);
        n = 0;
        test.start();

        <span class="comment">// wait for n == 1</span>
        printf(<span class="stringliteral">&quot;- thread should set n to 1...&quot;</span>);
        <span class="keywordflow">if</span> (WaitNValue(1)) OK
        <span class="keywordflow">else</span> ERROR;

        <span class="comment">// increment number in thread</span>
        printf(<span class="stringliteral">&quot;\nTesting thread is working\n\n&quot;</span>);
        n = 2;
        TEST_CHANGE(<span class="keyword">true</span>);
        TEST_CHANGE(<span class="keyword">true</span>);

        <span class="comment">// suspend thread, variable should not change</span>
        printf(<span class="stringliteral">&quot;\nTesting suspend &amp; resume\n\n&quot;</span>);
        test.suspend();
        TEST_CHANGE(<span class="keyword">false</span>);
        TEST_CHANGE(<span class="keyword">false</span>);

        <span class="comment">// resume, variable should change</span>
        test.resume();
        TEST_CHANGE(<span class="keyword">true</span>);
        TEST_CHANGE(<span class="keyword">true</span>);

        printf(<span class="stringliteral">&quot;\nTesting recursive suspend &amp; resume\n\n&quot;</span>);
        test.suspend();
        test.suspend();
        TEST_CHANGE(<span class="keyword">false</span>);
        TEST_CHANGE(<span class="keyword">false</span>);

        test.resume();
        TEST_CHANGE(<span class="keyword">false</span>);
        TEST_CHANGE(<span class="keyword">false</span>);
        test.resume();
        TEST_CHANGE(<span class="keyword">true</span>);
        TEST_CHANGE(<span class="keyword">true</span>);

        printf(<span class="stringliteral">&quot;\nTesting no suspend on resume\n\n&quot;</span>);
        test.resume();
        TEST_CHANGE(<span class="keyword">true</span>);
        TEST_CHANGE(<span class="keyword">true</span>);

        <span class="comment">// suspend thread, variable should not change</span>
        printf(<span class="stringliteral">&quot;\nTesting resuspend\n\n&quot;</span>);
        test.suspend();
        TEST_CHANGE(<span class="keyword">false</span>);
        TEST_CHANGE(<span class="keyword">false</span>);

        printf(<span class="stringliteral">&quot;\nNow program should finish... :)\n&quot;</span>);
        test.resume();

        <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Sun May 2 02:55:38 2010 for GNU CommonC++ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
